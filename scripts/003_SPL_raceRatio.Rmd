---
title: "003_SPL_RaceRatio"
date: "2024-05-08"
output: html_document
---

Recodes race, calculates racial/ethnic group proportions by location_id, and maps the proportions

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load required packages
```{r, message = FALSE}
rm(list=ls())
library(tidyverse)
library(sf)
library(here)
library(scales) # to edit decimal places shown in legend
```

# Import data
```{r}
SPL_1823 <- read.csv(here("data","SPL_1823.csv"))
SPL_1823_geo <- st_read(here("data", "SPL_1823_location.geojson")) # location_id shapefiles and lat/long coordinates
SEA_map <- st_read(here("data/raw","04_SPL_Seattle_Map.geojson")) # base SEA neighborhood map
```

# Recode the race column 
```{r}
SPL_1823 <- SPL_1823 %>%
  mutate(
    race=recode(staying_race_ethnicity,
                        "A" = "URM", # Asian
                        "B" = "URM", # Black or African American
                        "L" = "URM", # Latino/a or Hispanic
                        "M" = "URM", # Multiple, assumed to be multiracial
                        "N" = "URM", # Native American or Alaskan Native
                        "P" = "URM", # Pacific Island or Native Hawaiian, no observations in dataset
                        "U" = "Unsure", # Unsure
                        "W" = "White")) # White

table(SPL_1823$race)
table(SPL_1823$staying_race_ethnicity)

# Realized there were many blanks, so wanted to see where these were coming from

table(SPL_1823$staying_race_ethnicity[SPL_1823$study_id == "2023_Seattle_Citywide"])

# Confirmed that 2023 did not collect race data, so only have race data for 2018

SPL_18 <- SPL_1823 %>%
  filter(SPL_1823$study_id == "2018_Seattle_Citywide")

# Run tables again
table(SPL_18$race)
table(SPL_18$staying_race_ethnicity)

# Only 142 blanks now, which seems more normal

```

# Calculate race proportion by observation site (location_id), separate by racial group
```{r}
race_prop_locid <- SPL_18 %>%
  group_by(location_id, staying_race_ethnicity) %>%
  dplyr::summarise(count = n()) %>%
  pivot_wider(id_cols = location_id,
              names_from = staying_race_ethnicity,
              values_from = count,
              names_prefix = "Observed_") %>%
  replace(is.na(.), 0) %>%
  rowwise() %>%
  mutate(total_count = sum(c_across(starts_with("Observed_")))) %>%
  ungroup() %>%
  mutate(Asian_prop  = round(Observed_A/total_count, 2),
         Black_prop  = round(Observed_B/total_count, 2),
         Latinx_prop = round(Observed_L/total_count, 2),
         Multi_prop  = round(Observed_M/total_count, 2),
         NatAm_prop  = round(Observed_N/total_count, 2),
         White_prop  = round(Observed_W/total_count, 2)) %>%
  select(location_id, Asian_prop, Black_prop, Latinx_prop, Multi_prop, NatAm_prop, White_prop)
```

# Join location_id coordinates with 2018 filtered data
```{r}
<<<<<<< HEAD
race_prop_18_locid_geo <- left_join(race_prop_locid, SPL_1823_geo, by = "location_id")
=======
# Join the city map with 2018 filtered data ----
race_ratio_18_geo <- left_join(SEA_map, race_ratio, by = "S_HOOD")

ggplot() +
  geom_sf(data = race_ratio_18_geo, aes(fill = race_ratio)) +
  # geom_text(data = FM_ratio_18_geo, aes(label = S_HOOD, x=longitude, y=latitude), size = 3, color = "black", check_overlap = TRUE)+ #Need to troubleshoot
  scale_fill_gradient(name = "URM-to-White staying ratio",
                      low = "lightblue", high = "darkblue", na.value = "gray",
                      guide = guide_colorbar(title.position = "top")) +
  labs(title = "2018 URM-to-White Staying Ratio by Seattle Neighborhood ") +
  theme_minimal()+
  theme(
    plot.title = element_text(family = "Times New Roman", size = 16, face = "bold")
  )

# Save 2018 map as an PNG in the Visualization folder ----
#ggsave(filename = "2018_raceRatio_map.png", path = here("Visualization"), bg="white", height = 7, width = 7)
>>>>>>> 95c7e34b74536ba459af2e32e786a82e97262890
```


# Create map by dots (dots represent block face; color represents proportion)

## 2018 map - Asian
```{r}
ggplot() +
  geom_sf(data = SEA_map) + #plot base SEA neighborhood map
  geom_point(data = race_prop_18_locid_geo, 
             aes(x = longitude, y = latitude, color = Asian_prop),
             shape = 20, 
             size = 4, 
             alpha = 0.85) + # add points
  scale_color_continuous(name="Asian Proportion",
                         low = "lightblue", 
                         high = "darkblue",
                         limits = c(0,0.61),
                         labels = label_number(accuracy = 0.01)) +
  labs(title = "2018 Asian Staying Proportion by Observation Site") +
  labs(fill="Observation Sites")

# Save Map_2018_dot in the Visualization folder ----
ggsave(filename = "2018_raceRatio_Asian_map_dot.png", path = here("Visualization"), bg="white", width = 7, height = 7)
```

## 2018 map - Black
```{r}
ggplot() +
  geom_sf(data = SEA_map) + #plot base SEA neighborhood map
  geom_point(data = race_prop_18_locid_geo, 
             aes(x = longitude, y = latitude, color = Black_prop),
             shape = 20, 
             size = 4, 
             alpha = 0.85) + # add points
  scale_color_continuous(name="Black Proportion",
                         low = "lightblue", 
                         high = "darkblue",
                         labels = label_number(accuracy = 0.01)) +
  labs(title = "2018 Black Staying Proportion by Observation Site") +
  labs(fill="Observation Sites")

# Save Map_2018_dot in the Visualization folder ----
ggsave(filename = "2018_raceRatio_Black_map_dot.png", path = here("Visualization"), bg="white", width = 7, height = 7)
```


## 2018 map - Latinx
```{r}
ggplot() +
  geom_sf(data = SEA_map) + #plot base SEA neighborhood map
  geom_point(data = race_prop_18_locid_geo, 
             aes(x = longitude, y = latitude, color = Latinx_prop),
             shape = 20, 
             size = 4, 
             alpha = 0.85) + # add points
  scale_color_continuous(name="Latinx Proportion", 
                         low = "lightblue", 
                         high = "darkblue",
                         labels = label_number(accuracy = 0.01)) +
  labs(title = "2018 Latinx Staying Proportion by Observation Site") +
  labs(fill="Observation Sites")

# Save Map_2018_dot in the Visualization folder ----
ggsave(filename = "2018_raceRatio_Latinx_map_dot.png", path = here("Visualization"), bg="white", width = 7, height = 7)
```


## 2018 map - Multiracial
```{r}
ggplot() +
  geom_sf(data = SEA_map) + #plot base SEA neighborhood map
  geom_point(data = race_prop_18_locid_geo, 
             aes(x = longitude, y = latitude, color = Multi_prop),
             shape = 20, 
             size = 4, 
             alpha = 0.85) + # add points
  scale_color_continuous(name="Multiracial Proportion",
                         low = "lightblue", 
                         high = "darkblue",
                         labels = label_number(accuracy = 0.01)) +
  labs(title = "2018 Multiracial Staying Proportion by Observation Site") +
  labs(fill="Observation Sites")

# Save Map_2018_dot in the Visualization folder ----
ggsave(filename = "2018_raceRatio_Multi_map_dot.png", path = here("Visualization"), bg="white", width = 7, height = 7)
```


## 2018 map - Native American
```{r}
ggplot() +
  geom_sf(data = SEA_map) + #plot base SEA neighborhood map
  geom_point(data = race_prop_18_locid_geo, 
             aes(x = longitude, y = latitude, color = NatAm_prop),
             shape = 20, 
             size = 4, 
             alpha = 0.85) + # add points
  scale_color_continuous(name="Native American Proportion",
                         low = "lightblue", 
                         high = "darkblue",
                         labels = label_number(accuracy = 0.01)) +
  labs(title = "2018 Native American Staying Proportion by Observation Site") +
  labs(fill="Observation Sites")

# Save Map_2018_dot in the Visualization folder ----
ggsave(filename = "2018_raceRatio_NatAm_map_dot.png", path = here("Visualization"), bg="white", width = 7, height = 7)
```


## 2018 map - White
```{r}
ggplot() +
  geom_sf(data = SEA_map) + #plot base SEA neighborhood map
  geom_point(data = race_prop_18_locid_geo, 
             aes(x = longitude, y = latitude, color = White_prop),
             shape = 20, 
             size = 4, 
             alpha = 0.85) + # add points
  scale_color_continuous(name="White Proportion",
                         low = "lightblue", 
                         high = "darkblue",
                         limits = c(0,1),
                         labels = label_number(accuracy = 0.01)) +
  labs(title = "2018 White Staying Proportion by Observation Site") +
  labs(fill="Observation Sites")

# Save Map_2018_dot in the Visualization folder ----
ggsave(filename = "2018_raceRatio_White_map_dot.png", path = here("Visualization"), bg="white", width = 7, height = 7)
```
