---
title: "spl_staying_starter script"
output: html_document
date: "2024-04-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load required packages
```{r}
rm(list=ls())
#library(httr)
#library(jsonlite)
library(tidyverse)
library(psych)
library(dplyr)
library(sf)
library(leaflet)
```

# Getting the data from the Seattle Public Life Database
```{r}
SPL <- read.csv("data_files/Public_Life_Data_-_People_Staying_20240416.csv")

```

# Convert the code into character and create a sub dataset for 2018 and 2023 data
```{r}
#SPL_staying <- fromJSON(rawToChar(SPL$content))

#Create a separate dataset for 2018 and 2023 data
SPL_1823 <- SPL%>%
  filter(study_id=="2018_Seattle_Citywide" | study_id =="2023_Seattle_Citywide")
```

# Rename the gender column: 
```{r}
SPL_1823 <- SPL_1823 %>%
  mutate(
    gender=recode(staying_gender,
                        "Female"="Fem",
                        "Feminine presenting"="Fem",
                        "Gender-non-conforming presenting" = "non_conforming",
                        "Male"="Masc",
                        "Masculine presenting"="Masc",
                        "Other_Unsure"="Unsure",
                        "Unsure"="Unsure"))

table(SPL_1823$gender)
```

# Create a new neighborhood (might not need this)
```{r}
SPL_1823 <- SPL_1823 %>%
  mutate(
    neighborhood = gsub("\\d+","",location_id)) #\\d matches any digits, replaced it with an empty string

# check neighborhoods
unique(SPL_1823$neighborhood)
table(SPL_1823$neighborhood)

```


# Women/Men Ratio by location
```{r}
Ratio <- SPL_1823%>%
  group_by(neighborhood, gender, study_id)%>%
  dplyr::summarise(count= n())%>%
  pivot_wider(
    id_cols = c(neighborhood, study_id),
    names_from = gender,
    values_from = count,
    names_prefix = "Observed_"
  )%>%
  mutate(
    FM_ratio = round(Observed_Fem/Observed_Masc, 2)
  )%>%
  select(neighborhood, study_id, FM_ratio)
```

# Merge
```{r}
SPL_1823 <- left_join(SPL_1823, Ratio, by=c("neighborhood","study_id"))
```


# Geospatial data and study site data
```{r}
Geospatial <- st_read("https://data.seattle.gov/resource/v4q3-5hvp.geojson")

site <- read.csv("data_files/Public_Life_Data_Locations_Specific.csv")

#Combine Geo-spatial and site specific information
Geospatial <- left_join(Geospatial, site, by="location_id")

#ggplot(Geospatial)+geom_sf()
```

# Select relevant columns 
```{r}
#Combine Geospatial and SPL_1823 data----
SPL_plot <- left_join(SPL_1823, Geospatial, by="location_id")%>%
  select(unique_staying_id:location_id, #23 study has latitude and longitude
         FM_ratio,
         location_neighborhood,
         neighborhood,
         geometry)
```


# Base map: Seattle street map
```{r}
#Seattle street map
map <- st_read("data_files/Seattle_street_map.geojson") 

#S_Hood: neighborhood
#L_Hood: district
```

# Create 2018 map by neighborhood
```{r}
# Filter 2018 data ----
SPL_18 <- SPL_plot%>%
  filter(study_id=="2018_Seattle_Citywide")%>%
  mutate(
    neighborhood_recode = recode(location_neighborhood, #Check and record neiborhood names to match the base map neighborhoods
    "23rd & Union - Jackson" = "Pinehurst",
    "Capitol Hill"= "Broadway",
    "Bitter Lake Village" = "Bitter Lake",
    "Magnolia" = "Carleton Park",
    "Upper Queen Anne" = "North Queen Anne",
    "Pike/Pine" = "Pike-Market",
    "Greenwood - Phinney Ridge" = "Greenwood",
    "Westwood - Highland Park"= "Highland Park",
    "Othello" ="Columbia City",                
    "Madison Miller" = "Stevens",
    "Uptown" = "Lower Queen Anne",
    "First Hill / 12th Ave" = "Broadview",
    "West Seattle Junction" = "Gatewood",
    "Commercial Core" = "Central Business District",
    "Mt Baker"= "Mount Baker",              
    "Chinatown / ID" = "International District",          
    "Northgate" = "Maple Leaf",              
    "Lake City" = "Victory Heights"
  ))%>%
  mutate(
  longitude=st_coordinates(st_centroid(geometry))[,1], #Extract the longitude 
  latitude=st_coordinates(st_centroid(geometry))[,2]   #Extract the latitude
 )%>%
  select(neighborhood_recode,
         longitude,
         latitude,
         FM_ratio)
  

#Join the city map data with 2018 filtered data ----
merge <- left_join(map, SPL_18, by=c("S_HOOD"="neighborhood_recode"))
merge_no_na <- merge[!is.na(merge$FM_ratio),]


#Plot----
map_2018 <- ggplot() +
  geom_sf(data = merge, aes(fill = FM_ratio)) +
  #geom_text(data = merge_no_na, aes(label = S_HOOD, x=longitude, y=latitude), size = 3, color = "black", check_overlap = TRUE)+ #Need to troubleshoot
  scale_fill_gradient(name = "Female-to-male staying ratio",
                      low = "lightblue", high = "pink", na.value = "gray",
                      guide = guide_colorbar(title.position = "top")) +
  labs(title = "2018 Female-to-Male Staying Ratio by Seattle Neighborhood ") +
  theme_minimal()+
  theme(
    plot.title = element_text(family = "Times New Roman", size = 16, face = "bold")
  )
  

#  mutate(
#  longitude=st_coordinates(st_centroid(geometry))[,1], #Extract the longitude 
#  latitude=st_coordinates(st_centroid(geometry))[,2]   #Extract the latitude
# )

map_2018
```

# Create 2023 map by neighborhood
```{r}
SPL_23 <- SPL_plot%>%
  filter(study_id=="2023_Seattle_Citywide")%>%
  mutate(
    neighborhood_recode = recode(location_neighborhood,
    "Capitol Hill"= "Broadway",
    "Bitter Lake Village" = "Bitter Lake",
    "Chinatown / ID" = "International District",    
     "Commercial Core" = "Central Business District",
    "First Hill / 12th Ave" = "Broadview",
    "Lake City" = "Victory Heights",
    "Mt Baker"= "Mount Baker",
    "Northgate" = "Maple Leaf", 
    "Pike/Pine" = "Pike-Market",
    "Westwood - Highland Park"= "Highland Park",
    "Othello" ="Columbia City",               
    "Uptown" = "Lower Queen Anne"
  ))%>%
  select(neighborhood_recode,
         FM_ratio)


merge_23 <- left_join(map, SPL_23, by=c("S_HOOD"="neighborhood_recode"))


map_23 <- ggplot() +
  geom_sf(data = merge_23, aes(fill = FM_ratio)) +
  scale_fill_gradient(name = "Female-to-male staying ratio",
                      low = "lightblue", high = "pink", na.value = "gray",
                      guide = guide_colorbar(title.position = "top")) +
  labs(title = "2023 Female-to-Male Staying Ratio by Seattle Neighborhood ") +
  theme_minimal()+
  theme(
    plot.title = element_text(family = "Times New Roman", size = 16, face = "bold")
  )


map_23
```

# Alternative plot (dots represent neighborhood, size represents proportion)
## 2018 map
```{r}
# Extract the dots ----
Polygon <- SPL_plot%>%
  filter(study_id=="2018_Seattle_Citywide")%>%
  select(geometry, location_id)%>%
  mutate(
    Longitude = st_coordinates(st_centroid(geometry))[,1],
    Latitude = st_coordinates(st_centroid(geometry))[,2]
  )%>%
  st_as_sf()

# Drop the geometry----
Polygon <- Polygon%>%
  select(location_id, Longitude, Latitude)

Polygon <- st_cast(Polygon, "POINT")

ggplot(map)+
  geom_sf()+
  geom_sf(data=Polygon,shape=18, size = 1)+labs(fill="Observation Sites")


#Get the FM ratio by location_id again----
Ratio_block <- SPL_1823%>%
  group_by(location_id, gender, study_id)%>%
  dplyr::summarise(count= n())%>%
  pivot_wider(
    id_cols = c(location_id, study_id),
    names_from = gender,
    values_from = count,
    names_prefix = "Observed_"
  )%>%
  mutate(
    FM_ratio = round(Observed_Fem/Observed_Masc, 2)
  )%>%
  select(location_id, study_id, FM_ratio)


Ratio_block_2018 <- Ratio_block%>%
  filter(study_id=="2018_Seattle_Citywide")%>%
  select(location_id, FM_ratio)

#Merge the location dots with FM_ratio

merge_block <- right_join(Ratio_block_2018, Polygon, by="location_id")%>%
  st_as_sf()

ggplot(map)+geom_sf()+
  geom_point(data=merge_block, aes(x=Longitude, y=Latitude, color = FM_ratio),shape=20, size=4)+
  #scale_size_continuous(range=c(1,6))+
  scale_color_continuous(name="Female to Male Ratio",
                        low = "lightblue", high = "darkblue")+
  labs(fill="Observation Sites")

```














